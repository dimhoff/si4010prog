all: mtp_prog_generated.c

mtp_prog.ihx: mtp_prog.rel
mtp_prog.bin: mtp_prog.ihx
mtp_prog_generated.c: mtp_prog.bin

clean:
	@for f in mtp_prog; do \
		for e in bin ihx lnk lst map mem rel rst sym; do \
			rm -f $$f.$$e; \
		done; \
	done; \

#
# asx8051 is the assembler provided with the SDCC tools. The options provided to the assembler are:
# Option 	Purpose
#  l 	generates a list file
#  o 	generates an object file
#  ff 	flag reallocatable references by mode in listing file
#  g 	make undefined symbols be global
#  p 	disables listing pagination
#
# The "o" option is mandatory, as the linker requires list, object and symbol files to generate executables. The "ff" and "p" options generate a readable list file. The "g" option tells the assembler to not generate an error if it finds an undefined symbol that is not declared as external.
#
%.rel: %.asm
	@echo "ASM $<"; \
	/usr/bin/sdas8051 -wloffgp "$<"

#
# Option	Purpose
#  -i		Output Intel Hex
#  -m		Generate a map file
#  -b		Set base address of area
#  -e		end
#
#  WARNING: The <space> before the '-' in the echo(1) command is there on
#  purpose to prevent echo(1) from interpreting the '-' as an option(ie. '-e')
#  Yes, if your filename starts with a '-' it will also cause problems...
#
#  Sometimes sdld(1) returns with an error code but still generates the output
#  file. To fix this the extra rm(1) command is added on failure.
%.ihx: %.rel
	@echo "LD $@"; \
	{ \
		echo " -i"; \
		echo " -m"; \
		echo " -w"; \
		for f in $^; do \
			echo $$f ; \
		done ; \
		echo ' -e'; \
	} | sdld -n -c || { rm "$@"; false; }

%.bin: %.ihx
	@echo "MAKEBIN $@"; \
	makebin -p < "$<" > "$@"

%_generated.c: %.bin
	@echo "CUSTOM $@"; \
	{ \
		echo "/* WARNING: THIS FILE IS AUTO GENERATED BY THE MTP_PROG BUILD PROCESS */" ;\
		echo "// MTP_Prog firmware";\
		echo "const unsigned char mtp_prog_fw[] = {"; \
		xxd -i < "$<"; \
		echo "};"; \
		echo "// Address where to set breakpoint(eg. address of 'loop_breakpoint' label)" ;\
		sed -n 's/^[[:space:]]*00\([[:xdigit:]]*\)[[:space:]]*loop_breakpoint[[:space:]]*$$/#define MTP_PROG_BP_ADDR (0x\1)/p' "$*.map"; \
	} > "$@"
